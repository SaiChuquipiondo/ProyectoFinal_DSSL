<div class="page-container">
  <!-- Sidebar (mismo diseño) -->
  <app-estudiante-sidebar></app-estudiante-sidebar>

  <!-- Main Content -->
  <main class="main-content">
    <header class="content-header">
      <div>
        <h1>{{ isEditMode ? 'Resubir Proyecto Corregido' : 'Subir Proyecto de Tesis' }}</h1>
        <p class="breadcrumb">
          Inicio / {{ isEditMode ? 'Actualizar Proyecto' : 'Subir Proyecto' }}
        </p>
      </div>
    </header>

    <div class="content-body">
      <div class="form-container">
        <div class="form-header">
          <svg
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="#047857"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          <h2>{{ isEditMode ? 'Resubir Proyecto Corregido' : 'Nuevo Proyecto de Tesis' }}</h2>
          <p>
            {{
              isEditMode
                ? 'Corrige las observaciones y vuelve a subir tu proyecto'
                : 'Completa el formulario para subir tu proyecto de tesis'
            }}
          </p>
        </div>

        <form [formGroup]="proyectoForm" (ngSubmit)="onSubmit()" class="upload-form">
          <!-- Título -->
          <div class="form-group">
            <label for="titulo">
              Título del Proyecto
              <span class="required">*</span>
            </label>
            <input
              type="text"
              id="titulo"
              formControlName="titulo"
              class="form-control"
              placeholder="Ingrese el título completo de su proyecto"
              [class.invalid]="
                proyectoForm.get('titulo')?.invalid && proyectoForm.get('titulo')?.touched
              "
            />
            <div
              class="form-help"
              *ngIf="proyectoForm.get('titulo')?.invalid && proyectoForm.get('titulo')?.touched"
            >
              <span *ngIf="proyectoForm.get('titulo')?.errors?.['required']">
                El título es obligatorio
              </span>
              <span *ngIf="proyectoForm.get('titulo')?.errors?.['minlength']">
                El título debe tener al menos 10 caracteres
              </span>
            </div>
          </div>

          <!-- Especialidad -->
          <div class="form-group">
            <label for="especialidad">
              Especialidad
              <span class="required">*</span>
            </label>
            <select
              id="especialidad"
              formControlName="id_especialidad"
              class="form-control"
              [class.invalid]="
                proyectoForm.get('id_especialidad')?.invalid &&
                proyectoForm.get('id_especialidad')?.touched
              "
            >
              <option value="">Seleccione una especialidad</option>
              <option *ngFor="let esp of especialidades" [value]="esp.id_especialidad">
                {{ esp.nombre }}
              </option>
            </select>
            <div
              class="form-help"
              *ngIf="
                proyectoForm.get('id_especialidad')?.invalid &&
                proyectoForm.get('id_especialidad')?.touched
              "
            >
              Debe seleccionar una especialidad
            </div>
          </div>

          <!-- Asesor -->
          <div class="form-group">
            <label for="asesor">
              Asesor Propuesto
              <span class="required">*</span>
            </label>
            <select
              id="asesor"
              formControlName="id_asesor"
              class="form-control"
              [class.invalid]="
                proyectoForm.get('id_asesor')?.invalid && proyectoForm.get('id_asesor')?.touched
              "
              [disabled]="
                !proyectoForm.get('id_especialidad')?.value ||
                loadingAsesores ||
                (isEditMode && proyectoActual?.estado_asesor === 'APROBADO')
              "
            >
              <option value="">
                {{
                  loadingAsesores
                    ? 'Cargando asesores...'
                    : proyectoForm.get('id_especialidad')?.value
                    ? 'Seleccione un asesor'
                    : 'Primero seleccione una especialidad'
                }}
              </option>
              <option *ngFor="let asesor of asesores" [value]="asesor.id_docente">
                {{ asesor.nombre_completo }}
              </option>
            </select>
            <p
              class="field-info"
              *ngIf="
                proyectoForm.get('id_especialidad')?.value &&
                !loadingAsesores &&
                !(isEditMode && proyectoActual?.estado_asesor === 'APROBADO')
              "
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#6b7280"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="16" x2="12" y2="12" />
                <line x1="12" y1="8" x2="12.01" y2="8" />
              </svg>
              Los asesores mostrados pertenecen a la especialidad seleccionada
            </p>
            <p
              class="field-info field-locked"
              *ngIf="isEditMode && proyectoActual?.estado_asesor === 'APROBADO'"
            >
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#047857"
                stroke-width="2"
              >
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                <path d="M7 11V7a5 5 0 0 1 10 0v4" />
              </svg>
              El asesor ya fue aprobado por coordinación y no puede ser modificado
            </p>
            <div
              class="form-help"
              *ngIf="
                proyectoForm.get('id_asesor')?.invalid && proyectoForm.get('id_asesor')?.touched
              "
            >
              Debe seleccionar un asesor
            </div>
          </div>

          <!-- Resumen -->
          <div class="form-group">
            <label for="resumen">
              Resumen
              <span class="required">*</span>
            </label>
            <textarea
              id="resumen"
              formControlName="resumen"
              class="form-control"
              rows="6"
              placeholder="Describa brevemente el objetivo, metodología y resultados esperados de su investigación (mínimo 50 caracteres)"
              [class.invalid]="
                proyectoForm.get('resumen')?.invalid && proyectoForm.get('resumen')?.touched
              "
            ></textarea>
            <div class="char-counter">
              {{ proyectoForm.get('resumen')?.value?.length || 0 }} / 1000 caracteres
            </div>
            <div
              class="form-help"
              *ngIf="proyectoForm.get('resumen')?.invalid && proyectoForm.get('resumen')?.touched"
            >
              <span *ngIf="proyectoForm.get('resumen')?.errors?.['required']">
                El resumen es obligatorio
              </span>
              <span *ngIf="proyectoForm.get('resumen')?.errors?.['minlength']">
                El resumen debe tener al menos 50 caracteres
              </span>
            </div>
          </div>

          <!-- Archivo PDF -->
          <div class="form-group">
            <label for="pdf">
              Archivo PDF
              <span class="required" *ngIf="!isEditMode">*</span>
              <span class="optional" *ngIf="isEditMode">(opcional: solo si cambias el PDF)</span>
            </label>
            <div class="file-upload-container">
              <input
                type="file"
                id="pdf"
                (change)="onFileSelected($event)"
                accept=".pdf"
                class="file-input"
              />
              <label for="pdf" class="file-label">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="17 8 12 3 7 8" />
                  <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                <span *ngIf="!selectedFile"> Seleccionar archivo PDF</span>
                <span *ngIf="selectedFile" class="file-name">{{ selectedFile.name }}</span>
              </label>
            </div>
            <p class="file-help">Formato: PDF | Tamaño máximo: 10MB</p>
          </div>

          <!-- Botones -->
          <div class="form-actions">
            <button
              type="button"
              routerLink="/estudiante/proyectos"
              class="btn-secondary"
              [disabled]="uploading"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="proyectoForm.invalid || !selectedFile || uploading"
            >
              <span *ngIf="!uploading">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="20 6 9 17 4 12" />
                </svg>
                Subir {{ isEditMode ? 'Correcciones' : 'Proyecto' }}
              </span>
              <span *ngIf="uploading" class="uploading">
                <div class="spinner-small"></div>
                Subiendo...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>
